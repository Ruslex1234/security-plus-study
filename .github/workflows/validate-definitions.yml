name: Validate Security+ Content

on:
  push:
    branches: [ main, claude/** ]
    paths:
      - '**.json'
      - '**.md'
      - '**.html'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "üîç Validating JSON files..."

          # Validate acronyms.json
          if jq empty acronyms.json 2>/dev/null; then
            ACRONYM_COUNT=$(jq 'length' acronyms.json)
            echo "‚úÖ acronyms.json is valid ($ACRONYM_COUNT acronyms)"
          else
            echo "‚ùå acronyms.json is invalid!"
            exit 1
          fi

          # Validate security-plus-definitions.json
          if jq empty security-plus-definitions.json 2>/dev/null; then
            DEF_COUNT=$(jq '[.[] | length] | add' security-plus-definitions.json)
            echo "‚úÖ security-plus-definitions.json is valid ($DEF_COUNT definitions)"
          else
            echo "‚ùå security-plus-definitions.json is invalid!"
            exit 1
          fi

      - name: Extract terms from Objectives.md
        run: |
          echo "üìã Extracting terms from Objectives.md..."

          # Extract potential acronyms (2+ uppercase letters)
          grep -oE '\b[A-Z]{2,}[A-Z0-9]*\b' Objectives.md | sort -u > /tmp/found_acronyms.txt

          echo "Found $(wc -l < /tmp/found_acronyms.txt) potential acronyms in Objectives.md"

      - name: Check for missing acronyms
        run: |
          echo "üîé Checking for missing acronyms..."

          MISSING_ACRONYMS=""
          while IFS= read -r acronym; do
            # Skip common words that aren't acronyms
            if [[ "$acronym" =~ ^(IT|OS|IM|ID)$ ]]; then
              continue
            fi

            if ! jq -e --arg key "$acronym" '.[$key]' acronyms.json > /dev/null 2>&1; then
              MISSING_ACRONYMS="$MISSING_ACRONYMS\n  - $acronym"
            fi
          done < /tmp/found_acronyms.txt

          if [ -n "$MISSING_ACRONYMS" ]; then
            echo "‚ö†Ô∏è Missing acronyms found:$MISSING_ACRONYMS"
            echo "MISSING_ACRONYMS<<EOF" >> $GITHUB_ENV
            echo -e "$MISSING_ACRONYMS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "‚úÖ All acronyms are defined!"
          fi

      - name: Generate coverage report
        run: |
          echo "üìä Generating coverage report..."

          TOTAL_ACRONYMS=$(jq 'length' acronyms.json)
          TOTAL_DEFINITIONS=$(jq '[.[] | length] | add' security-plus-definitions.json)

          echo "## üìà Security+ Content Coverage" > coverage-report.md
          echo "" >> coverage-report.md
          echo "- **Acronyms defined:** $TOTAL_ACRONYMS" >> coverage-report.md
          echo "- **Terms with definitions:** $TOTAL_DEFINITIONS" >> coverage-report.md
          echo "" >> coverage-report.md

          if [ -n "$MISSING_ACRONYMS" ]; then
            echo "### ‚ö†Ô∏è Missing Acronyms" >> coverage-report.md
            echo "$MISSING_ACRONYMS" >> coverage-report.md
          fi

          cat coverage-report.md

      - name: Validate HTML references
        run: |
          echo "üåê Checking HTML file references..."

          # Check if index.html loads the JSON files
          if grep -q "fetch('./acronyms.json')" index.html; then
            echo "‚úÖ index.html loads acronyms.json"
          else
            echo "‚ùå index.html doesn't load acronyms.json!"
            exit 1
          fi

          if grep -q "fetch('./security-plus-definitions.json')" index.html; then
            echo "‚úÖ index.html loads security-plus-definitions.json"
          else
            echo "‚ùå index.html doesn't load security-plus-definitions.json!"
            exit 1
          fi

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('coverage-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report.md
